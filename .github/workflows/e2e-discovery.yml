name: e2e-discovery

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  e2e-discovery:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: true

      - name: E2E Discovery Tests
        run: go test -tags=e2e_discovery ./e2e -v
        timeout-minutes: 15

      - name: Upload diagnostics
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: e2e-diagnostics-${{ github.run_id }}
          path: |
            e2e/diag-*.log
            e2e/diag-*.txt
          if-no-files-found: ignore
          retention-days: 7
