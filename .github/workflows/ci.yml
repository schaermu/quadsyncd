name: ci
on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify tidy
        run: |
          go mod tidy
          git diff --exit-code
      - name: Govulncheck
        run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...

      - name: Lint
        run: |
          go run github.com/golangci/golangci-lint/cmd/golangci-lint@latest run

      - name: Test
        run: go test -v -race -coverprofile=coverage.txt ./...

      - name: Compute coverage
        id: coverage
        run: |
          go tool cover -func=coverage.txt > /tmp/coverage-func.txt
          echo "total=$(grep ^total /tmp/coverage-func.txt | awk '{print $3}')" >> $GITHUB_OUTPUT

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          COVERAGE_TOTAL: ${{ steps.coverage.outputs.total }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const total = process.env.COVERAGE_TOTAL;
            const pct = parseFloat(total);
            const indicator = pct >= 80 ? 'ðŸŸ¢' : pct >= 60 ? 'ðŸŸ¡' : 'ðŸ”´';
            const report = fs.readFileSync('/tmp/coverage-func.txt', 'utf8');
            const lines = report.trim().split('\n');
            const funcLines = lines.filter(l => !l.startsWith('total:'));
            const tableRows = funcLines.map(line => {
              const parts = line.trim().split(/\t+/).filter(Boolean);
              if (parts.length < 3) return null;
              const filePath = parts[0];
              const funcName = parts[1].trim();
              const coverage = parts[2].trim();
              return `| \`${filePath}\` | \`${funcName}\` | ${coverage} |`;
            }).filter(Boolean).join('\n');
            const marker = '<!-- quadsyncd-coverage-report -->';
            const body = [
              marker,
              '## ðŸ“Š Code Coverage',
              '',
              `${indicator} Total coverage: **${total}**`,
              '',
              '<details>',
              '<summary>Per-function coverage breakdown</summary>',
              '',
              '| File | Function | Coverage |',
              '|------|----------|----------|',
              tableRows,
              '</details>',
              '',
              '_Coverage report generated by GitHub Actions_',
            ].join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Integration Tests (Tier 1)
        run: go test -tags=integration ./integration/tier1 -v

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          COVERAGE_TOTAL: ${{ steps.coverage.outputs.total }}
        run: |
          mkdir -p .github/badges
          python3 << 'PYEOF'
          import os
          pct = float(os.environ.get('COVERAGE_TOTAL', '0%').rstrip('%'))
          color = '#4c1' if pct >= 80 else ('#dfb317' if pct >= 60 else '#e05d44')
          label = 'coverage'
          value = f'{pct:.1f}%'
          lw = 68
          vw = max(38, len(value) * 7 + 12)
          tw = lw + vw
          lx = lw // 2
          vx = lw + vw // 2
          svg = f"""<svg xmlns="http://www.w3.org/2000/svg" width="{tw}" height="20" role="img" aria-label="{label}: {value}">
            <title>{label}: {value}</title>
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <clipPath id="r">
              <rect width="{tw}" height="20" rx="3" fill="#fff"/>
            </clipPath>
            <g clip-path="url(#r)">
              <rect width="{lw}" height="20" fill="#555"/>
              <rect x="{lw}" width="{vw}" height="20" fill="{color}"/>
              <rect width="{tw}" height="20" fill="url(#s)"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="{lx}" y="15" fill="#010101" fill-opacity=".3">{label}</text>
              <text x="{lx}" y="14">{label}</text>
              <text x="{vx}" y="15" fill="#010101" fill-opacity=".3">{value}</text>
              <text x="{vx}" y="14">{value}</text>
            </g>
          </svg>"""
          with open('.github/badges/coverage.svg', 'w') as f:
              f.write(svg)
          PYEOF

      - name: Commit coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .github/badges/coverage.svg
          git diff --staged --quiet || (git commit -m 'chore: update coverage badge [skip ci]' && git push)

  build:
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: darwin
            goarch: amd64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -trimpath -o quadsyncd-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/quadsyncd
