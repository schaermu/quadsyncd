name: ci
on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      coverage-total: ${{ steps.coverage.outputs.total }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify tidy
        run: |
          go mod tidy
          git diff --exit-code
      - name: Govulncheck
        run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...

      - name: Lint
        run: |
          go run github.com/golangci/golangci-lint/cmd/golangci-lint@latest run

      - name: Test
        run: go test -v -race -coverprofile=coverage.txt ./...

      - name: Compute coverage
        id: coverage
        run: |
          go tool cover -func=coverage.txt > /tmp/coverage-func.txt
          echo "total=$(grep ^total /tmp/coverage-func.txt | awk '{print $3}')" >> $GITHUB_OUTPUT

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          COVERAGE_TOTAL: ${{ steps.coverage.outputs.total }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const total = process.env.COVERAGE_TOTAL;
            const pct = parseFloat(total);
            const indicator = pct >= 80 ? 'ðŸŸ¢' : pct >= 60 ? 'ðŸŸ¡' : 'ðŸ”´';
            const report = fs.readFileSync('/tmp/coverage-func.txt', 'utf8');
            const lines = report.trim().split('\n');
            const funcLines = lines.filter(l => !l.startsWith('total:'));
            const tableRows = funcLines.map(line => {
              const parts = line.trim().split(/\t+/).filter(Boolean);
              if (parts.length < 3) return null;
              const filePath = parts[0];
              const funcName = parts[1].trim();
              const coverage = parts[2].trim();
              return `| \`${filePath}\` | \`${funcName}\` | ${coverage} |`;
            }).filter(Boolean).join('\n');
            const marker = '<!-- quadsyncd-coverage-report -->';
            const body = [
              marker,
              '## ðŸ“Š Code Coverage',
              '',
              `${indicator} Total coverage: **${total}**`,
              '',
              '<details>',
              '<summary>Per-function coverage breakdown</summary>',
              '',
              '| File | Function | Coverage |',
              '|------|----------|----------|',
              tableRows,
              '</details>',
              '',
              '_Coverage report generated by GitHub Actions_',
            ].join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Integration Tests (Tier 1)
        run: go test -tags=integration ./integration/tier1 -v

  update-badge:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Update coverage badge data
        env:
          COVERAGE_TOTAL: ${{ needs.test.outputs.coverage-total }}
        run: |
          PCT="${COVERAGE_TOTAL%\%}"
          if awk "BEGIN{exit !($PCT >= 80)}"; then COLOR="brightgreen"
          elif awk "BEGIN{exit !($PCT >= 60)}"; then COLOR="yellow"
          else COLOR="red"; fi
          printf '{"schemaVersion":1,"label":"coverage","message":"%s","color":"%s"}\n' \
            "$COVERAGE_TOTAL" "$COLOR" > .github/badges/coverage.json

      - name: Commit coverage badge data
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .github/badges/coverage.json
          git diff --staged --quiet || (git commit -m 'chore: update coverage badge [skip ci]' && git push)

  build:
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: darwin
            goarch: amd64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -trimpath -o quadsyncd-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/quadsyncd
